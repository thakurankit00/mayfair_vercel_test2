name: Sync Aiven DB with Supabase

run-name: "DB Sync â€¢ Supabase â†’ Aiven â€¢ ${{ github.actor }}"

on:
  workflow_dispatch:
    inputs:
      confirm_sync:
        description: 'Type "CONFIRM" to proceed with database sync (this will overwrite Aiven DB)'
        required: true
        type: string

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ” Validate confirmation
        run: |
          if [ "${{ github.event.inputs.confirm_sync }}" != "CONFIRM" ]; then
            echo "âŒ Error: Database sync not confirmed!"
            echo "Please type 'CONFIRM' in the input field to proceed with the sync."
            echo "âš ï¸  WARNING: This operation will overwrite the Aiven database with Supabase data!"
            exit 1
          fi
          
          echo "âœ… Database sync confirmed - proceeding with operation"
          echo "ðŸ”„ This will sync Supabase (source) â†’ Aiven (destination)"

  sync-database:
    needs: validate
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ”§ Install PostgreSQL client
        run: |
          echo "ðŸ“¦ Installing PostgreSQL client tools..."
          sudo apt-get update
          sudo apt-get install -y postgresql-client
          
          echo "âœ… PostgreSQL client installed"
          psql --version

      - name: ðŸ”„ Sync Database (Supabase â†’ Aiven)
        run: |
          echo "ðŸš€ Starting database sync operation..."
          echo "ðŸ“¤ Source: Supabase (aws-1-ap-southeast-1.pooler.supabase.com)"
          echo "ðŸ“¥ Destination: Aiven (mayfair-mailcow.k.aivencloud.com)"
          echo ""
          
          echo "â³ Dumping data from Supabase and importing to Aiven..."
          
          # Set PGPASSWORD for source database
          export PGPASSWORD="${{ secrets.SUPABASE_DB_PASSWORD }}"
          
          # Run the sync command
          pg_dump \
            --host=aws-1-ap-southeast-1.pooler.supabase.com \
            --port=6543 \
            --username=postgres.aglpkgpajcgjdlfunwyr \
            --dbname=postgres \
            --no-owner \
            --no-acl \
            --verbose \
          | psql "postgres://avnadmin:${{ secrets.AIVEN_DB_PASSWORD }}@mayfair-mailcow.k.aivencloud.com:19870/defaultdb?sslmode=require"
          
          if [ $? -eq 0 ]; then
            echo "âœ… Database sync completed successfully!"
          else
            echo "âŒ Database sync failed!"
            exit 1
          fi
        env:
          PGPASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}

      - name: ðŸ“ Create Sync Summary
        run: |
          echo "## ðŸ”„ Database Sync Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Sync Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Source:** Supabase (aws-1-ap-southeast-1.pooler.supabase.com)" >> $GITHUB_STEP_SUMMARY
          echo "- **Destination:** Aiven (mayfair-mailcow.k.aivencloud.com)" >> $GITHUB_STEP_SUMMARY
          echo "- **Operation:** Full database dump and restore" >> $GITHUB_STEP_SUMMARY
          echo "- **Options:** --no-owner --no-acl" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Execution Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** âœ… Completed Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **Note:** The Aiven database has been overwritten with Supabase data." >> $GITHUB_STEP_SUMMARY